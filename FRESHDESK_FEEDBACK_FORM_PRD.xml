<?xml version="1.0" encoding="UTF-8"?>
<product_requirements_document>
  <metadata>
    <title>Freshdesk Feedback Form Integration</title>
    <version>1.0</version>
    <date>2025-12-11</date>
    <description>Product Requirements Document for Freshdesk feedback form integration with Atlassian-style sidebar integration</description>
  </metadata>

  <overview>
    <summary>
      Integrate Freshdesk feedback widget into the application sidebar, providing users with an easy way to submit feedback directly from the application interface. The implementation follows Atlassian's design pattern with feedback buttons at the bottom of both desktop and mobile sidebars.
    </summary>
    <objectives>
      <objective>Provide users with accessible feedback submission mechanism</objective>
      <objective>Maintain consistent UI/UX with existing sidebar design</objective>
      <objective>Support both light and dark themes</objective>
      <objective>Ensure responsive design for mobile and desktop</objective>
    </objectives>
  </overview>

  <requirements>
    <functional_requirements>
      <requirement id="FR-001">
        <title>Feedback Modal Component</title>
        <description>Create a modal component that displays the Freshdesk feedback widget</description>
        <acceptance_criteria>
          <criterion>Modal must load Freshdesk widget script dynamically when opened</criterion>
          <criterion>Modal must load Freshdesk widget CSS dynamically</criterion>
          <criterion>Modal must use xlarge size (600px height) for better form visibility</criterion>
          <criterion>Modal must have title "Send us your feedback" and subtitle "We'd love to hear from you"</criterion>
          <criterion>Modal must support standard modal close functionality (X button, ESC key, click outside)</criterion>
        </acceptance_criteria>
        <implementation>
          <file>components/modals/FeedbackModal.tsx</file>
          <details>
            <item>Component uses Modal component with size="xlarge"</item>
            <item>Dynamically loads Freshdesk widget script from https://s3.amazonaws.com/assets.freshdesk.com/widget/freshwidget.js</item>
            <item>Dynamically loads Freshdesk widget CSS</item>
            <item>Embeds Freshdesk iframe with URL: https://irongrove-help.freshdesk.com/widgets/feedback_widget/new?&widgetType=embedded&searchArea=no</item>
            <item>Iframe height set to 600px</item>
            <item>searchArea=no parameter hides "Search Articles" tab, showing only "Help & Support" form</item>
          </details>
        </implementation>
      </requirement>

      <requirement id="FR-002">
        <title>Dark Mode Support</title>
        <description>Ensure Freshdesk widget adapts to application dark mode theme</description>
        <acceptance_criteria>
          <criterion>Widget must be readable in dark mode</criterion>
          <criterion>Widget styling must match application dark theme</criterion>
          <criterion>Theme changes must be applied dynamically when modal opens</criterion>
        </acceptance_criteria>
        <implementation>
          <file>components/modals/FeedbackModal.tsx</file>
          <details>
            <item>Uses useSettingsStore to detect current theme (general.theme === 'dark')</item>
            <item>Injects custom CSS for dark mode using filter: invert(0.9) hue-rotate(180deg)</item>
            <item>Sets iframe background to #1a1b1e in dark mode</item>
            <item>Sets modal content background to #1a1b1e in dark mode</item>
            <item>Removes dark mode styling when switching to light mode</item>
            <item>Custom style element has ID 'freshdesk-dark-mode-override' for easy removal</item>
          </details>
        </implementation>
      </requirement>

      <requirement id="FR-003">
        <title>Desktop Sidebar Integration</title>
        <description>Add feedback button to desktop sidebar in both collapsed and expanded states</description>
        <acceptance_criteria>
          <criterion>Button must appear at bottom of desktop sidebar</criterion>
          <criterion>Button must have different UI for collapsed vs expanded states</criterion>
          <criterion>Collapsed state shows icon only (w-6 h-6 size)</criterion>
          <criterion>Expanded state shows icon + "Give feedback" text</criterion>
          <criterion>Button must have hover state (orange background, white text)</criterion>
          <criterion>Button must be visible in both light and dark modes</criterion>
        </acceptance_criteria>
        <implementation>
          <file>components/layout/Sidebar.tsx</file>
          <details>
            <item>Feedback button section placed at bottom of desktop sidebar with border-top separator</item>
            <item>Conditional rendering based on isCollapsed state</item>
            <item>Collapsed: Icon-only button (w-6 h-6 icon, p-2 padding, rounded-md)</item>
            <item>Expanded: Full button with icon (w-5 h-5) + text, gap-3, px-4 py-3 padding, rounded-lg</item>
            <item>Light mode: bg-gray-200 background, text-gray-900 text, border-gray-300 border</item>
            <item>Dark mode: bg-gray-800 background, text-gray-300 text, no border</item>
            <item>Hover state: bg-orange background, text-white text for both modes</item>
            <item>Uses chat bubble icon SVG</item>
            <item>Button has aria-label="Give feedback" and title="Give feedback" for accessibility</item>
          </details>
        </implementation>
      </requirement>

      <requirement id="FR-004">
        <title>Mobile Sidebar Integration</title>
        <description>Add feedback button to mobile sidebar with auto-close functionality</description>
        <acceptance_criteria>
          <criterion>Button must appear at bottom of mobile sidebar</criterion>
          <criterion>Button must match desktop expanded state styling</criterion>
          <criterion>Opening feedback modal must automatically close mobile sidebar</criterion>
          <criterion>Button must be visible in both light and dark modes</criterion>
        </acceptance_criteria>
        <implementation>
          <file>components/layout/Sidebar.tsx</file>
          <details>
            <item>Feedback button section placed at bottom of mobile sidebar with border-top separator</item>
            <item>Full button with icon (w-5 h-5) + "Give feedback" text</item>
            <item>onClick handler calls setIsFeedbackModalOpen(true) and onMobileMenuClose()</item>
            <item>Same styling as desktop expanded state</item>
            <item>Light mode: bg-gray-200 background, text-gray-900 text, border-gray-300 border</item>
            <item>Dark mode: bg-gray-800 background, text-gray-300 text, no border</item>
            <item>Hover state: bg-orange background, text-white text</item>
          </details>
        </implementation>
      </requirement>

      <requirement id="FR-005">
        <title>Modal Click-Outside-to-Close Fix</title>
        <description>Fix modal click-outside-to-close functionality to work properly</description>
        <acceptance_criteria>
          <criterion>Clicking outside modal must close the modal</criterion>
          <criterion>Clicking inside modal content must not close the modal</criterion>
          <criterion>Fix must work for all modals including feedback modal</criterion>
        </acceptance_criteria>
        <implementation>
          <file>components/ui/Modal.tsx</file>
          <details>
            <item>Added onClick={onClose} handler to overlay div</item>
            <item>Added onClick={onClose} handler to outer modal wrapper div</item>
            <item>Added onClick={(e) => e.stopPropagation()} to modal content div</item>
            <item>stopPropagation prevents clicks inside modal from bubbling up to close handlers</item>
            <item>Ensures proper event handling for click-outside-to-close functionality</item>
          </details>
        </implementation>
      </requirement>
    </functional_requirements>

    <non_functional_requirements>
      <requirement id="NFR-001">
        <title>Performance</title>
        <description>Freshdesk widget scripts must load efficiently</description>
        <acceptance_criteria>
          <criterion>Scripts must only load when modal is opened</criterion>
          <criterion>Scripts must not reload if already present in DOM</criterion>
          <criterion>No performance degradation on sidebar rendering</criterion>
        </acceptance_criteria>
        <implementation>
          <details>
            <item>Script loading checks for existing script element by ID before adding</item>
            <item>CSS loading checks for existing style element by ID before adding</item>
            <item>All loading happens in useEffect hook triggered by isOpen prop</item>
            <item>Scripts use async attribute for non-blocking loading</item>
          </details>
        </implementation>
      </requirement>

      <requirement id="NFR-002">
        <title>Accessibility</title>
        <description>Feedback form must be accessible to all users</description>
        <acceptance_criteria>
          <criterion>Buttons must have proper aria-labels</criterion>
          <criterion>Modal must be keyboard navigable</criterion>
          <criterion>Focus management must work correctly</criterion>
        </acceptance_criteria>
        <implementation>
          <details>
            <item>All feedback buttons have aria-label="Give feedback"</item>
            <item>Collapsed button has title="Give feedback" for tooltip</item>
            <item>Modal component handles ESC key for closing</item>
            <item>Modal has proper ARIA attributes</item>
          </details>
        </implementation>
      </requirement>

      <requirement id="NFR-003">
        <title>Responsive Design</title>
        <description>Feedback form must work on all screen sizes</description>
        <acceptance_criteria>
          <criterion>Mobile sidebar must display feedback button correctly</criterion>
          <criterion>Desktop sidebar must display feedback button correctly in both states</criterion>
          <criterion>Modal must be responsive and usable on mobile devices</criterion>
        </acceptance_criteria>
        <implementation>
          <details>
            <item>Mobile sidebar uses full-width button with proper padding</item>
            <item>Desktop sidebar adapts button size based on collapsed state</item>
            <item>Modal uses responsive sizing with xlarge option</item>
            <item>Iframe uses 100% width for responsive behavior</item>
          </details>
        </implementation>
      </requirement>
    </non_functional_requirements>
  </requirements>

  <technical_specifications>
    <components>
      <component>
        <name>FeedbackModal</name>
        <file_path>components/modals/FeedbackModal.tsx</file_path>
        <description>Client component that renders Freshdesk feedback widget in a modal</description>
        <props>
          <prop>
            <name>isOpen</name>
            <type>boolean</type>
            <required>true</required>
            <description>Controls modal visibility</description>
          </prop>
          <prop>
            <name>onClose</name>
            <type>() => void</type>
            <required>true</required>
            <description>Callback function to close the modal</description>
          </prop>
        </props>
        <dependencies>
          <dependency>Modal component from @/components/ui/Modal</dependency>
          <dependency>useSettingsStore from @/lib/settings-store</dependency>
          <dependency>Freshdesk widget script and CSS (loaded dynamically)</dependency>
        </dependencies>
      </component>

      <component>
        <name>Sidebar</name>
        <file_path>components/layout/Sidebar.tsx</file_path>
        <description>Sidebar component with integrated feedback button</description>
        <modifications>
          <modification>
            <type>Import</type>
            <details>Added import for FeedbackModal component</details>
          </modification>
          <modification>
            <type>State</type>
            <details>Added isFeedbackModalOpen state using useState</details>
          </modification>
          <modification>
            <type>UI Addition</type>
            <details>Added feedback button section at bottom of mobile sidebar</details>
          </modification>
          <modification>
            <type>UI Addition</type>
            <details>Added feedback button section at bottom of desktop sidebar with collapsed/expanded states</details>
          </modification>
          <modification>
            <type>Component Addition</type>
            <details>Added FeedbackModal component at end of component tree</details>
          </modification>
        </modifications>
      </component>

      <component>
        <name>Modal</name>
        <file_path>components/ui/Modal.tsx</file>
        <description>Base modal component with click-outside-to-close fix</description>
        <modifications>
          <modification>
            <type>Event Handling</type>
            <details>Added onClick={onClose} to overlay div</details>
          </modification>
          <modification>
            <type>Event Handling</type>
            <details>Added onClick={onClose} to outer wrapper div</details>
          </modification>
          <modification>
            <type>Event Handling</type>
            <details>Added onClick={(e) => e.stopPropagation()} to modal content div</details>
          </modification>
        </modifications>
      </component>
    </components>

    <styling>
      <theme_support>
        <light_mode>
          <feedback_button>
            <background>bg-gray-200</background>
            <text_color>text-gray-900</text_color>
            <border>border border-gray-300</border>
            <hover_background>bg-orange</hover_background>
            <hover_text>text-white</hover_text>
          </feedback_button>
        </light_mode>
        <dark_mode>
          <feedback_button>
            <background>bg-gray-800</background>
            <text_color>text-gray-300</text_color>
            <border>no border</border>
            <hover_background>bg-orange</hover_background>
            <hover_text>text-white</hover_text>
          </feedback_button>
          <freshdesk_widget>
            <iframe_filter>filter: invert(0.9) hue-rotate(180deg)</iframe_filter>
            <background>#1a1b1e</background>
            <implementation>CSS injection via style element with ID 'freshdesk-dark-mode-override'</implementation>
          </freshdesk_widget>
        </dark_mode>
      </theme_support>
    </styling>

    <external_integrations>
      <integration>
        <name>Freshdesk Widget</name>
        <type>Third-party iframe embed</type>
        <url>https://irongrove-help.freshdesk.com/widgets/feedback_widget/new?&widgetType=embedded&searchArea=no</url>
        <script_url>https://s3.amazonaws.com/assets.freshdesk.com/widget/freshwidget.js</script_url>
        <css_url>https://s3.amazonaws.com/assets.freshdesk.com/widget/freshwidget.css</css_url>
        <parameters>
          <parameter>
            <name>widgetType</name>
            <value>embedded</value>
            <description>Specifies embedded widget mode</description>
          </parameter>
          <parameter>
            <name>searchArea</name>
            <value>no</value>
            <description>Hides "Search Articles" tab, showing only feedback form</description>
          </parameter>
        </parameters>
      </integration>
    </external_integrations>
  </technical_specifications>

  <user_experience>
    <user_flows>
      <flow>
        <name>Desktop Feedback Submission</name>
        <steps>
          <step>User views desktop sidebar</step>
          <step>User sees "Give feedback" button at bottom of sidebar</step>
          <step>User clicks feedback button</step>
          <step>Modal opens with Freshdesk feedback form</step>
          <step>User fills out feedback form</step>
          <step>User submits feedback</step>
          <step>User closes modal via X button, ESC key, or click outside</step>
        </steps>
      </flow>

      <flow>
        <name>Mobile Feedback Submission</name>
        <steps>
          <step>User opens mobile sidebar menu</step>
          <step>User sees "Give feedback" button at bottom of sidebar</step>
          <step>User clicks feedback button</step>
          <step>Mobile sidebar automatically closes</step>
          <step>Modal opens with Freshdesk feedback form</step>
          <step>User fills out feedback form</step>
          <step>User submits feedback</step>
          <step>User closes modal via X button, ESC key, or click outside</step>
        </steps>
      </flow>

      <flow>
        <name>Collapsed Sidebar Feedback</name>
        <steps>
          <step>User collapses desktop sidebar</step>
          <step>User sees feedback icon only (no text)</step>
          <step>User hovers over icon to see "Give feedback" tooltip</step>
          <step>User clicks icon</step>
          <step>Modal opens with Freshdesk feedback form</step>
        </steps>
      </flow>
    </user_flows>

    <design_patterns>
      <pattern>
        <name>Atlassian-style Sidebar Integration</name>
        <description>Feedback button placed at bottom of sidebar, similar to Atlassian products</description>
        <rationale>Familiar UX pattern that users recognize and expect</rationale>
      </pattern>
    </design_patterns>
  </user_experience>

  <implementation_notes>
    <note>
      <title>Script Loading Strategy</title>
      <content>Freshdesk scripts are loaded dynamically only when modal opens to avoid unnecessary network requests and improve initial page load performance.</content>
    </note>
    <note>
      <title>Dark Mode Implementation</title>
      <content>Dark mode styling uses CSS filter inversion technique because Freshdesk widget does not natively support dark themes. The filter is applied to the iframe element and removed when switching back to light mode.</content>
    </note>
    <note>
      <title>Icon Sizing</title>
      <content>Collapsed sidebar uses w-6 h-6 icon size to match organization icons and improve visibility. Expanded state uses w-5 h-5 for better proportion with text.</content>
    </note>
    <note>
      <title>Search Area Parameter</title>
      <content>The searchArea=no parameter was added to hide the "Search Articles" tab, showing only the feedback form. This provides a cleaner, more focused experience for direct feedback submission.</content>
    </note>
    <note>
      <title>Modal Click-Outside Fix</title>
      <content>The click-outside-to-close functionality was fixed by adding stopPropagation to the modal content div. This ensures clicks inside the modal don't trigger the close handler, while clicks on the overlay or wrapper still close the modal.</content>
    </note>
  </implementation_notes>

  <files_modified>
    <file>
      <path>components/modals/FeedbackModal.tsx</path>
      <status>created</status>
      <lines_added>94</lines_added>
      <description>New component for Freshdesk feedback widget modal</description>
    </file>
    <file>
      <path>components/layout/Sidebar.tsx</path>
      <status>modified</status>
      <changes>
        <change>Added FeedbackModal import</change>
        <change>Added isFeedbackModalOpen state</change>
        <change>Added mobile feedback button section</change>
        <change>Added desktop feedback button section (collapsed/expanded)</change>
        <change>Added FeedbackModal component</change>
        <change>Updated button styling for light mode visibility</change>
      </changes>
    </file>
    <file>
      <path>components/ui/Modal.tsx</path>
      <status>modified</status>
      <changes>
        <change>Added onClick handlers for click-outside-to-close</change>
        <change>Added stopPropagation to modal content</change>
      </changes>
    </file>
  </files_modified>

  <testing_requirements>
    <test_case>
      <id>TC-001</id>
      <title>Feedback Modal Opens</title>
      <steps>Click feedback button in desktop sidebar</steps>
      <expected_result>Modal opens with Freshdesk feedback form</expected_result>
    </test_case>
    <test_case>
      <id>TC-002</id>
      <title>Feedback Modal Closes</title>
      <steps>Open modal, click X button</steps>
      <expected_result>Modal closes</expected_result>
    </test_case>
    <test_case>
      <id>TC-003</id>
      <title>Click Outside to Close</title>
      <steps>Open modal, click outside modal content</steps>
      <expected_result>Modal closes</expected_result>
    </test_case>
    <test_case>
      <id>TC-004</id>
      <title>Dark Mode Styling</title>
      <steps>Switch to dark mode, open feedback modal</steps>
      <expected_result>Widget is readable with dark theme styling</expected_result>
    </test_case>
    <test_case>
      <id>TC-005</id>
      <title>Mobile Sidebar Auto-Close</title>
      <steps>Open mobile sidebar, click feedback button</steps>
      <expected_result>Sidebar closes, modal opens</expected_result>
    </test_case>
    <test_case>
      <id>TC-006</id>
      <title>Collapsed Sidebar Icon</title>
      <steps>Collapse sidebar, verify feedback icon visibility</steps>
      <expected_result>Icon is visible and clickable</expected_result>
    </test_case>
    <test_case>
      <id>TC-007</id>
      <title>Light Mode Button Visibility</title>
      <steps>Switch to light mode, verify feedback button visibility</steps>
      <expected_result>Button is clearly visible with proper contrast</expected_result>
    </test_case>
  </testing_requirements>

  <deployment>
    <prerequisites>
      <prerequisite>Freshdesk account configured with feedback widget</prerequisite>
      <prerequisite>Freshdesk widget URL: https://irongrove-help.freshdesk.com/widgets/feedback_widget/new</prerequisite>
    </prerequisites>
    <considerations>
      <consideration>No environment variables required - widget URL is hardcoded</consideration>
      <consideration>Freshdesk scripts load from AWS S3 CDN</consideration>
      <consideration>No backend changes required</consideration>
    </considerations>
  </deployment>
</product_requirements_document>

